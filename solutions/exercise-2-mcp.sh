#!/bin/bash
# Solution: Exercise 2 - MCP Integration

echo "=== Setting up MCP Servers ==="

# Step 1: Configure PostgreSQL MCP Server
echo "Adding PostgreSQL MCP server..."
claude mcp add --transport stdio db -- npx -y @bytebase/dbhub \
  --dsn "postgresql://admin:password123@localhost:5432/ecommerce"

# Step 2: Configure GitHub MCP Server
echo "Adding GitHub MCP server..."
claude mcp add --transport http github https://api.githubcopilot.com/mcp/

# Step 3: Verify both servers
echo "Verifying MCP servers..."
claude mcp list

echo ""
echo "=== MCP Servers configured successfully! ==="
echo ""
echo "Now start Claude Code and run:"
echo ""
echo "claude"
echo "> Using the MCP servers:"
echo "> "
echo "> 1. Query the database to find all products where stock < 5"
echo "> 2. Create a detailed report with: product ID, name, current stock, price"
echo "> 3. Create a GitHub issue in this repository titled \"Low Inventory Alert - $(date +%Y-%m-%d)\""
echo "> 4. In the issue body, include:"
echo ">    - Summary of how many products are affected"
echo ">    - Table with product details"
echo ">    - Suggested action items"
echo "> 5. Add labels \"inventory\" and \"urgent\" to the issue"
echo "> "
echo "> After creating the issue, share the URL with me."

# Expected Workflow:

# Claude will:
# 1. Connect to PostgreSQL via MCP
# 2. Execute: SELECT id, name, stock, price FROM products WHERE stock < 5
# 3. Process results into a formatted report
# 4. Connect to GitHub via MCP
# 5. Create issue with title: "Low Inventory Alert - 2024-01-15"
# 6. Body content:
#    ## Summary
#    Found 3 products with low inventory (stock < 5)
#
#    ## Affected Products
#
#    | ID | Name | Current Stock | Price |
#    |----|------|---------------|-------|
#    | 42 | Wireless Mouse | 2 | $29.99 |
#    | 87 | USB Cable | 4 | $9.99 |
#    | 103 | Laptop Stand | 1 | $49.99 |
#
#    ## Recommended Actions
#
#    - [ ] Review sales velocity for these products
#    - [ ] Place restock orders for high-demand items
#    - [ ] Consider adjusting reorder thresholds
#    - [ ] Notify sales team of limited availability
#
#    ---
#    Generated by Claude Code MCP Integration
#
# 7. Apply labels: ["inventory", "urgent"]
# 8. Return issue URL: https://github.com/youruser/repo/issues/123

# Success Criteria:
# ✅ Both MCP servers connected
# ✅ Database query executed successfully
# ✅ GitHub issue created with proper formatting
# ✅ Labels applied correctly
# ✅ Issue URL returned

# Troubleshooting:

# Problem: Database connection refused
# Solution:
#   docker ps | grep postgres
#   # If not running:
#   cd ecommerce-api
#   docker-compose up -d

# Problem: GitHub authentication failed
# Solution:
#   export GITHUB_TOKEN=your_token_here
#   claude mcp remove github
#   claude mcp add --transport http github https://api.githubcopilot.com/mcp/ \
#     --header "Authorization: Bearer $GITHUB_TOKEN"

# Problem: MCP server not found
# Solution:
#   claude mcp list
#   # If missing, re-run setup commands above

# Alternative: Project-scoped MCP for team
# claude mcp add --scope project db -- npx -y @bytebase/dbhub \
#   --dsn "postgresql://admin:password123@localhost:5432/ecommerce"
# claude mcp add --scope project github https://api.githubcopilot.com/mcp/
# git add .mcp.json
# git commit -m "feat: add MCP servers for team"
